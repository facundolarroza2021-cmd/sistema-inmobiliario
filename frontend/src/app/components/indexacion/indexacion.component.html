<mat-card class="indexacion-card mat-elevation-z8">
    <mat-card-header>
      <mat-icon mat-card-avatar color="accent">trending_up</mat-icon>
      <mat-card-title>Indexación Masiva de Alquileres</mat-card-title>
      <mat-card-subtitle>Ajuste el monto base de alquiler y las cuotas futuras de los contratos.</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content class="mt-3">
      
      <mat-horizontal-stepper #stepper [linear]="false">
        
        <mat-step label="Definir Ajuste" [stepControl]="ajusteForm">
          <form [formGroup]="ajusteForm" (ngSubmit)="previsualizarAjuste()">
            
            <div class="row custom-row">
              <mat-form-field appearance="outline" class="col-md-6">
                <mat-label>Tipo de Ajuste</mat-label>
                <mat-select formControlName="tipoAjuste" required>
                  <mat-option value="porcentaje">Porcentaje Fijo (%)</mat-option>
                  <mat-option value="monto_fijo">Monto Fijo (+ $)</mat-option>
                </mat-select>
                <mat-error *ngIf="ajusteForm.get('tipoAjuste')?.invalid && ajusteForm.get('tipoAjuste')?.touched">
                  Seleccione el tipo de ajuste.
                </mat-error>
              </mat-form-field>
  
              <mat-form-field appearance="outline" class="col-md-6">
                <mat-label>Valor de Ajuste</mat-label>
                <input matInput type="number" formControlName="valorAjuste" required min="0" step="0.01">
                <mat-hint>{{ ajusteForm.get('tipoAjuste')?.value === 'porcentaje' ? 'Ej: 10.5 (Para 10.5%)' : 'Ej: 5000 (Para $5000)' }}</mat-hint>
                <mat-error *ngIf="ajusteForm.get('valorAjuste')?.invalid && ajusteForm.get('valorAjuste')?.touched">
                  El valor debe ser positivo.
                </mat-error>
              </mat-form-field>
            </div>
  
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Fecha de Aplicación (Mes/Año)</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="fechaAplicacion" required>
              <mat-hint>El ajuste aplicará a cuotas con periodo igual o posterior a este mes.</mat-hint>
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              <mat-error *ngIf="ajusteForm.get('fechaAplicacion')?.invalid && ajusteForm.get('fechaAplicacion')?.touched">
                Seleccione la fecha de inicio.
              </mat-error>
            </mat-form-field>
  
            <div class="stepper-actions mt-4">
              <button mat-raised-button 
                      color="primary" 
                      type="submit"
                      [disabled]="ajusteForm.invalid || isApplying">
                <mat-icon>search</mat-icon>
                {{ isApplying ? 'Buscando Contratos...' : 'Previsualizar Contratos' }}
              </button>
              <mat-spinner diameter="20" *ngIf="isApplying" class="ml-2"></mat-spinner>
            </div>
  
          </form>
        </mat-step>
  
        <mat-step label="Revisar Contratos" [completed]="selection.hasValue()">
          
          <div class="alert-message" *ngIf="!contratosAjustados || contratosAjustados.length === 0">
            <mat-icon>info</mat-icon>
            No se encontraron contratos activos con cuotas futuras pendientes que cumplan los criterios de fecha.
          </div>
          
          <div *ngIf="contratosAjustados && contratosAjustados.length > 0">
            <p class="summary-text">
              Se encontraron **{{ contratosAjustados.length }}** contratos activos. Seleccione cuáles desea ajustar.
            </p>
  
            <div class="mat-elevation-z2 table-container">
              <table mat-table [dataSource]="dataSource" matSort>
  
                <ng-container matColumnDef="select">
                  <th mat-header-cell *matHeaderCellDef class="selection-column">
                    <mat-checkbox (change)="$event ? masterToggle() : null"
                                  [checked]="selection.hasValue() && isAllSelected()"
                                  [indeterminate]="selection.hasValue() && !isAllSelected()"
                                  [aria-label]="checkboxLabel()">
                    </mat-checkbox>
                  </th>
                  <td mat-cell *matCellDef="let row" class="selection-column">
                    <mat-checkbox (click)="$event.stopPropagation()"
                                  (change)="$event ? selection.toggle(row) : null"
                                  [checked]="selection.isSelected(row)"
                                  [aria-label]="checkboxLabel(row)">
                    </mat-checkbox>
                  </td>
                </ng-container>
  
                <ng-container matColumnDef="contrato">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Contrato / Inquilino </th>
                  <td mat-cell *matCellDef="let contrato"> 
                    <span class="font-weight-bold">#{{ contrato.id }}</span>
                    <br>
                    <small>{{ contrato.inquilino.nombre_completo }}</small>
                  </td>
                </ng-container>
  
                <ng-container matColumnDef="montoActual">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Monto Base Actual </th>
                  <td mat-cell *matCellDef="let contrato"> 
                    <span class="text-muted">{{ contrato.monto_alquiler | currency:'USD':'symbol':'1.2-2':'es' }}</span>
                  </td>
                </ng-container>
  
                <ng-container matColumnDef="montoNuevo">
                  <th mat-header-cell *matHeaderCellDef> Nuevo Monto Base </th>
                  <td mat-cell *matCellDef="let contrato"> 
                    <span class="text-success font-weight-bold">
                      {{ calcularNuevoMonto(contrato.monto_alquiler) | currency:'USD':'symbol':'1.2-2':'es' }} 
                    </span>
                  </td>
                </ng-container>
  
                <ng-container matColumnDef="cuotasAfectadas">
                  <th mat-header-cell *matHeaderCellDef> Cuotas Afectadas </th>
                  <td mat-cell *matCellDef="let contrato"> 
                      <mat-chip color="accent" selected>
                          {{ contrato.cuotas_afectadas }}
                      </mat-chip>
                  </td>
                </ng-container>
  
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="mat-row-pointer" 
                    (click)="selection.toggle(row)"></tr>
              </table>
  
              <mat-paginator [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons></mat-paginator>
            </div>
          </div>
  
          <div class="stepper-actions mt-3">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon> Volver al Ajuste
            </button>
            <button mat-raised-button 
                    color="accent" 
                    matStepperNext 
                    [disabled]="!selection.hasValue() || isApplying">
              Aplicar a ({{ selection.selected.length }}) Contratos <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </mat-step>
  
        <mat-step label="Aplicar y Confirmar">
          <div class="confirmation-section">
            <h3 class="mt-3">Confirmación Final</h3>
            <p>
              Está a punto de aplicar un ajuste de tipo <span class="badge-info">{{ ajusteForm.get('tipoAjuste')?.value | uppercase }}</span> 
              (valor: <span class="badge-value">{{ ajusteForm.get('valorAjuste')?.value | number:'1.2-2' }}</span>) 
              a **{{ selection.selected.length }}** contratos.
            </p>
            <p class="text-danger">
              **ATENCIÓN:** Esta acción modificará el monto base del contrato y ajustará las cuotas futuras pendientes de pago a partir del mes de **{{ ajusteForm.get('fechaAplicacion')?.value | date:'MMMM yyyy':'UTC':'es' }}**. Confirme para continuar.
            </p>
          </div>
          
          <div class="stepper-actions mt-4">
            <button mat-button matStepperPrevious [disabled]="isApplying">
              <mat-icon>edit</mat-icon> Modificar Selección
            </button>
            <button mat-raised-button 
                    color="warn" 
                    (click)="aplicarAjuste()"
                    [disabled]="isApplying">
              <mat-icon>check_circle</mat-icon>
              {{ isApplying ? 'Aplicando...' : 'Confirmar Ajuste Masivo' }}
            </button>
            <mat-spinner diameter="20" *ngIf="isApplying" class="ml-2"></mat-spinner>
          </div>
        </mat-step>
  
      </mat-horizontal-stepper>
  
    </mat-card-content>
  </mat-card>