<div class="container-fluid" style="padding: 30px 40px;">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4 header-indexacion">
      <div class="d-flex align-items-center gap-3">
        <div class="icon-box-indexacion">
          <mat-icon>trending_up</mat-icon>
        </div>
        <div>
          <h1 class="m-0 fw-bold fs-4">Ajuste e Indexación</h1>
          <small class="text-muted">Actualiza el monto de alquiler aplicando un porcentaje desde una fecha.</small>
        </div>
      </div>
    </div>
  
    <!-- MENSAJE INICIAL (solo si no hay contrato) -->
    <div *ngIf="!contratoSeleccionado?.id" class="mat-elevation-z1 hint-panel-index mb-3">
      <mat-icon>info</mat-icon>
      Seleccioná un contrato para ver el detalle y aplicar el ajuste.
    </div>
  
    <!-- CONTENIDO EN DOS COLUMNAS -->
    <div class="grid-2cols">
  
      <!-- IZQUIERDA: FORM (selección + parámetros) -->
      <mat-card class="mat-elevation-z2">
        <mat-card-header>
          <mat-card-title>Selección y Parámetros</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <form #indexacionForm="ngForm" (ngSubmit)="aplicarAjuste()">
  
            <!-- BUSCADOR DE CONTRATO DENTRO DEL FORM -->
            <div class="row-index mb-2">
              <div class="col-12">
                <mat-form-field appearance="outline" class="search-field-indexacion w-100">
                  <mat-label>Buscar Contrato (Inquilino o Propiedad)</mat-label>
                  <input
                    matInput
                    [matAutocomplete]="auto"
                    [(ngModel)]="contratoSeleccionado"
                    (ngModelChange)="filtrarContratos($event)"
                    name="buscador"
                    placeholder="Ej. Juan Pérez o Av. Siempre Viva"
                    required
                  >
                  <mat-icon matSuffix>search</mat-icon>
                  <mat-autocomplete
                    #auto="matAutocomplete"
                    (optionSelected)="seleccionarContrato($event.option.value)"
                    [displayWith]="displayContrato"
                  >
                    <mat-option *ngFor="let c of contratosFiltrados" [value]="c">
                      {{ c.propiedad?.direccion }} — {{ c.inquilino?.nombre_completo }}
                    </mat-option>
                  </mat-autocomplete>
                  <mat-error *ngIf="indexacionForm.submitted && !contratoSeleccionado?.id">
                    Debés seleccionar un contrato válido.
                  </mat-error>
                </mat-form-field>
              </div>
            </div>
  
            <mat-divider class="mb-3"></mat-divider>
  
            <!-- PARÁMETROS DEL AJUSTE -->
            <div class="form-grid form-grid-3">
                <!-- Porcentaje -->
                <div class="field">
                <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Porcentaje de Aumento (%)</mat-label>
                    <input
                    matInput
                    type="number"
                    [(ngModel)]="ajusteData.porcentaje"
                    name="porcentaje"
                    required
                    min="0.01"
                    step="0.01"
                    >
                    <span matSuffix>%</span>
                    <mat-hint>Ej: 25.50</mat-hint>
                    <mat-error *ngIf="indexacionForm.submitted && indexacionForm.controls['porcentaje']?.invalid">
                    Ingresá un porcentaje válido (mayor a 0).
                    </mat-error>
                </mat-form-field>
                </div>
            
                <!-- Fecha -->
                <div class="field">
                <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Fecha de Aplicación</mat-label>
                    <input
                    matInput
                    [matDatepicker]="picker"
                    [(ngModel)]="ajusteData.fechaAplicacion"
                    name="fechaAplicacion"
                    required
                    >
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                    <mat-hint>Desde esta cuota</mat-hint>
                    <mat-error *ngIf="indexacionForm.submitted && indexacionForm.controls['fechaAplicacion']?.invalid">
                    Seleccioná una fecha.
                    </mat-error>
                </mat-form-field>
                </div>
            
                <!-- Motivo -->
                <div class="field">
                <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Motivo del Ajuste</mat-label>
                    <input
                    matInput
                    [(ngModel)]="ajusteData.motivo"
                    name="motivo"
                    required
                    >
                    <mat-icon matSuffix>info</mat-icon>
                    <mat-hint>Referencia o cláusula del contrato.</mat-hint>
                    <mat-error *ngIf="indexacionForm.submitted && indexacionForm.controls['motivo']?.invalid">
                    Especificá un motivo.
                    </mat-error>
                </mat-form-field>
                </div>
            </div>
  
            <!-- TEXTO INFORMATIVO BAJO LOS CAMPOS -->
            <div class="info-panel mt-12">
                <mat-icon class="me-1">lightbulb</mat-icon>
                El ajuste impactará a partir de la fecha seleccionada y se reflejará en las cuotas futuras. Revisá la vista previa del nuevo monto a la derecha antes de confirmar.
            </div>
  
            <!-- ACCIÓN -->
            <div class="d-flex-end mt-12">
              <button
                mat-raised-button
                color="primary"
                type="submit"
                [disabled]="indexacionForm.invalid || cargando || !contratoSeleccionado?.id"
              >
                <mat-icon *ngIf="!cargando" class="me-1">sync</mat-icon>
                <mat-spinner *ngIf="cargando" diameter="20"></mat-spinner>
                Aplicar Ajuste
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
  
      <!-- DERECHA: FORM (resumen + previa) -->
      <form #resumenForm="ngForm" novalidate>
        <div class="stack-12">
          <mat-card class="mat-elevation-z2">
            <mat-card-header>
              <mat-card-title>Resumen del Contrato</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="kv">
                <div class="k">Contrato ID</div>
                <div class="v">{{ contratoSeleccionado?.id || '-' }}</div>
              </div>
              <div class="kv">
                <div class="k">Inquilino</div>
                <div class="v">{{ contratoSeleccionado?.inquilino?.nombre_completo || '-' }}</div>
              </div>
              <div class="kv">
                <div class="k">Propiedad</div>
                <div class="v">{{ contratoSeleccionado?.propiedad?.direccion || '-' }}</div>
              </div>
              <div class="kv">
                <div class="k">Monto Actual</div>
                <div class="v monto-actual">$ {{ contratoSeleccionado?.monto_alquiler | number:'1.2-2' }}</div>
              </div>
              <div class="kv">
                <div class="k">Vigencia</div>
                <div class="v">
                  {{ contratoSeleccionado?.fecha_inicio | date:'shortDate' }} — {{ contratoSeleccionado?.fecha_fin | date:'shortDate' }}
                </div>
              </div>
              <div class="kv">
                <div class="k">Última Indexación</div>
                <div class="v">{{ contratoSeleccionado?.ultima_indexacion || 'N/A' }}</div>
              </div>
            </mat-card-content>
          </mat-card>
  
          <mat-card class="mat-elevation-z2">
            <mat-card-header>
              <mat-card-title>Vista previa del Ajuste</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="preview-box-index">
                <div class="label">Nuevo Monto Estimado</div>
                <div class="monto-nuevo">$ {{ calcularNuevoMonto() | number:'1.2-2' }}</div>
                <div class="hint">Se aplicará a {{ cuotasAfectadas }} cuotas futuras.</div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </form>
  
    </div>
  </div>