<div class="container-fluid" style="padding: 30px 40px;">

    <div class="d-flex justify-content-between align-items-center mb-4 header-cobros">
      
      <div class="d-flex align-items-center gap-3">
        <div class="icon-box-cobros">
          <mat-icon>point_of_sale</mat-icon>
        </div>
        <div>
          <h1 class="m-0 fw-bold fs-4">Caja y Cobros</h1>
          <small class="text-muted">Gestión de deudas pendientes por inquilino/contrato.</small>
        </div>
      </div>
  
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Buscar Inquilino o Periodo...</mat-label>
        <input matInput (keyup)="aplicarFiltro($event)" placeholder="Ej. Juan o 2025-01">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  
    <div *ngIf="cargando" class="loading-spinner">
      <mat-spinner diameter="50" color="primary"></mat-spinner>
      <p class="mt-2 text-muted">Cargando deudas pendientes...</p>
    </div>
  
    <div class="mat-elevation-z2 table-container-cobros" [hidden]="cargando">
      <table mat-table [dataSource]="dataSource" matSort>
  
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef class="col-select">
            <mat-checkbox (change)="$event ? toggleAllRows() : null"
                          [checked]="selection.hasValue() && isAllSelected()"
                          [indeterminate]="selection.hasValue() && !isAllSelected()">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row" class="col-select">
            <mat-checkbox (click)="$event.stopPropagation()"
                          (change)="$event ? selection.toggle(row) : null"
                          [checked]="selection.isSelected(row)"
                          [disabled]="row.estado === 'PAGADA'">
            </mat-checkbox>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="periodo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Periodo </th>
          <td mat-cell *matCellDef="let element"> 
            <span class="periodo-badge">
              {{element.periodo}}
            </span>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="inquilino">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Inquilino </th>
          <td mat-cell *matCellDef="let element"> 
              <strong>{{element.contrato?.inquilino?.nombre_completo}}</strong>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="propiedad">
          <th mat-header-cell *matHeaderCellDef> Propiedad </th>
          <td mat-cell *matCellDef="let element"> 
               {{element.contrato?.propiedad?.direccion}}
          </td>
        </ng-container>
  
        <ng-container matColumnDef="monto">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-end"> Saldo Pendiente </th>
          <td mat-cell *matCellDef="let element" class="text-end col-monto"> 
            <span class="monto-pendiente" *ngIf="element.saldo_pendiente > 0">
              $ {{element.saldo_pendiente | number:'1.0-2'}}
            </span>
            <span class="monto-pagado" *ngIf="element.saldo_pendiente == 0">
              $ 0 <mat-icon>check_circle</mat-icon>
            </span>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
          <td mat-cell *matCellDef="let element">
            <mat-chip-listbox>
                <mat-chip-option 
                    [color]="element.estado === 'PAGADA' ? 'success' : element.estado === 'PENDIENTE' ? 'warn' : 'primary'"
                    [selected]="true"
                    class="status-chip-cobros">
                    {{ element.estado }}
                </mat-chip-option>
            </mat-chip-listbox>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="accion">
          <th mat-header-cell *matHeaderCellDef class="text-center"> Recibo </th>
          <td mat-cell *matCellDef="let element" class="text-center">
            <button *ngIf="element.estado === 'PAGADA'" 
                    mat-mini-fab color="primary" 
                    matTooltip="Ver Recibo PDF"
                    (click)="verComprobante(element)">
              <mat-icon>picture_as_pdf</mat-icon>
            </button>
          </td>
        </ng-container>
  
        <tr mat-header-row *matHeaderRowDef="columnas"></tr>
        <tr mat-row *matRowDef="let row; columns: columnas;"></tr>
  
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" colspan="7" class="no-data-row">
            <mat-icon>search_off</mat-icon>
            <p>No se encontraron deudas.</p>
          </td>
        </tr>
      </table>
  
      <mat-paginator [pageSizeOptions]="[10, 20, 50]" showFirstLastButtons></mat-paginator>
    </div>

    <div *ngIf="selection.selected.length > 0" class="floating-action-bar-cobros shadow-lg">
        <div class="d-flex justify-content-between align-items-center w-100">
            
            <div class="text-white resumen-flotante">
                <span class="fs-6 d-block text-uppercase">Cobro Múltiple Seleccionado</span>
                <strong class="fs-3 fw-bold">$ {{ calcularTotalFlotante() | number:'1.0-2'}}</strong>
            </div>

            <button mat-raised-button 
                    class="btn-cobrar-flotante"
                    (click)="cobrarSeleccionados()">
                <mat-icon>checklist</mat-icon> 
                PROCESAR COBRO ({{ selection.selected.length }} ITEMS)
            </button>
        </div>
    </div>
  </div>